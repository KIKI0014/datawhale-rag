# å¤šæ¨¡æ€RAGç³»ç»Ÿï¼šä»100åˆ†åˆ°110åˆ†çš„ä¼˜åŒ–å®æˆ˜

## ğŸ“‹ é¡¹ç›®èƒŒæ™¯

### æ¯”èµ›åœºæ™¯
- **å¤šæ¨¡æ€RAGå›¾æ–‡é—®ç­”æŒ‘æˆ˜èµ›**
- **806ä¸ªæµ‹è¯•é—®é¢˜**ï¼Œæ¶‰åŠå¤æ‚çš„ä¸­æ–‡è´¢åŠ¡æ–‡æ¡£
- **è¯„åˆ†æ ‡å‡†**ï¼š
  - ç­”æ¡ˆå†…å®¹ç›¸ä¼¼åº¦ï¼š0.5åˆ†æƒé‡
  - æ–‡ä»¶ååŒ¹é…ï¼š0.25åˆ†æƒé‡
  - é¡µç åŒ¹é…ï¼š0.25åˆ†æƒé‡

### æ€§èƒ½è¡¨ç°
- **åŸºç¡€ç‰ˆæœ¬**ï¼š~100åˆ†
- **å½“å‰ç‰ˆæœ¬**ï¼š105-110åˆ†
- **é¢„æœŸæå‡**ï¼šå¾®è°ƒåå¯è¾¾120-135åˆ†

## ğŸ—ï¸ ç³»ç»Ÿæ¶æ„

### æ•´ä½“æŠ€æœ¯æ ˆ
```
PDFæ–‡æ¡£ â†’ MinerUè§£æ â†’ å¢å¼ºåˆ†å— â†’ å‘é‡åŒ–å­˜å‚¨ â†’ åŒé˜¶æ®µæ£€ç´¢ â†’ åæ€é‡å†™ â†’ æœ€ç»ˆç­”æ¡ˆ
```

### æ ¸å¿ƒæ¨¡å—
1. **mineru_parse_pdf.py** - PDFè§£æå¼•æ“
2. **mineru_pipeline_all.py** - å¤„ç†æµæ°´çº¿
3. **rag_from_page_chunks.py** - æ£€ç´¢ç³»ç»Ÿ

## ğŸ¯ æ ¸å¿ƒåˆ›æ–°ç‚¹

### 1. å¢å¼ºåˆ†å—ç­–ç•¥ï¼ˆäº”ç»´åº¦åˆ†å—ï¼‰

#### é¡µé¢çº§chunks - ä¿è¯é¡µç åŒ¹é…
```python
# å®Œæ•´é¡µé¢ä¿ç•™ï¼Œç¡®ä¿é¡µç å‡†ç¡®åŒ¹é…
chunks.append({
    "id": f"{file_name}_page_{page_idx}",
    "content": page_content.strip(),
    "metadata": {
        "page": str(page_idx),
        "chunk_type": "page"
    }
})
```

#### æ®µè½çº§chunks - æå‡å†…å®¹ç›¸ä¼¼åº¦
```python
# æ™ºèƒ½é‡å åˆ†å‰²ï¼š800å­—ç¬¦ + 100å­—ç¬¦é‡å 
def split_text_into_chunks(text, max_length=800, overlap=100):
    # ä¼˜å…ˆåœ¨å¥å·å¤„åˆ†å‰²ï¼Œä¿æŒè¯­ä¹‰å®Œæ•´
    if end < len(text):
        last_period = text.rfind('ã€‚', start, end)
        if last_period > start + max_length // 2:
            end = last_period + 1
```

#### è¡¨æ ¼ç‹¬ç«‹chunks - ç»“æ„åŒ–å†…å®¹ä¸“é¡¹å¤„ç†
```python
# è¡¨æ ¼å†…å®¹å•ç‹¬å¤„ç†ï¼Œä¿ç•™HTMLç»“æ„
chunks.append({
    "content": table_html,
    "chunk_type": "table"
})
```

#### è·¨é¡µé‡å chunks - è§£å†³è¾¹ç•Œä¿¡æ¯ä¸¢å¤±
```python
# å‰ä¸€é¡µæœ«å°¾ + å½“å‰é¡µå¼€å¤´ï¼Œå¤„ç†è·¨é¡µå†…å®¹
cross_page_content = prev_text + curr_text
chunks.append({
    "page": f"{page_idx-1}-{page_idx}",
    "chunk_type": "cross_page"
})
```

#### å¤šæ¨¡æ€è§†è§‰å¢å¼º - å›¾ç‰‡captionè‡ªåŠ¨ç”Ÿæˆ
```python
# ä½¿ç”¨Qwen2.5-VLæ¨¡å‹è‡ªåŠ¨ç”Ÿæˆå›¾ç‰‡æè¿°
async with AsyncImageAnalysis(
    vision_model="Pro/Qwen/Qwen2.5-VL-7B-Instruct"
) as analyzer:
    caption = await analyzer.analyze_image(img_path)
```

### 2. åŒé˜¶æ®µæ£€ç´¢æ¶æ„

#### ç¬¬ä¸€é˜¶æ®µï¼šç²—å¬å›ï¼ˆå‘é‡æ£€ç´¢ï¼‰
```python
def coarse_search(self, query_embedding, top_k=25):
    # ä½™å¼¦ç›¸ä¼¼åº¦è®¡ç®—
    sims = emb_matrix @ query_emb / (norm(emb_matrix, axis=1) * norm(query_emb))
    # è¿”å›top_kä¸ªå€™é€‰é¡¹
    return candidates
```

#### ç¬¬äºŒé˜¶æ®µï¼šç²¾æ’åºï¼ˆBGE-ReRankerï¼‰
```python
def fine_rerank(self, query, candidates, top_k=7):
    # æ„å»ºæŸ¥è¯¢-æ–‡æ¡£å¯¹
    pairs = [[query, candidate] for candidate in candidates]
    # BGEæ¨¡å‹è®¡ç®—ç²¾ç¡®ç›¸å…³æ€§åˆ†æ•°
    rerank_scores = self.reranker.compute_score(pairs)
    # åˆ†æ•°èåˆï¼šé‡æ’åº70% + å‘é‡ç›¸ä¼¼åº¦30%
    final_score = rerank_score * 0.7 + coarse_score * 0.3
```

### 3. åæ€é‡å†™æœºåˆ¶

#### ä¿¡æ¯å……è¶³æ€§åˆ¤æ–­
```python
def judge_information_sufficiency(self, question, chunks):
    reflection_prompt = f"""
    é—®é¢˜ï¼š{question}
    æ£€ç´¢ä¿¡æ¯ï¼š{context}
    
    è¯·åˆ¤æ–­ï¼š
    1. ä¿¡æ¯æ˜¯å¦è¶³å¤Ÿå®Œæ•´ï¼Ÿ
    2. ç¼ºå°‘ä»€ä¹ˆå…³é”®ä¿¡æ¯ï¼Ÿ
    3. éœ€è¦ä»€ä¹ˆæ›´å…·ä½“çš„æŸ¥è¯¢ï¼Ÿ
    
    è¿”å›JSONï¼š{{"sufficient": true/false, "new_query": "è¡¥å……æŸ¥è¯¢"}}
    """
```

#### æ™ºèƒ½äºŒæ¬¡æ£€ç´¢
```python
def generate_answer_with_reflection(self, question):
    # ç¬¬ä¸€è½®æ£€ç´¢
    initial_chunks = self.vector_store.search(query, top_k=7, coarse_k=25)
    
    # åæ€åˆ¤æ–­
    reflection = self.judge_information_sufficiency(question, initial_chunks)
    
    if not reflection["sufficient"]:
        # ç¬¬äºŒè½®æ£€ç´¢
        new_query = reflection["new_query"]
        additional_chunks = self.vector_store.search(new_query, ...)
        # åˆå¹¶å»é‡
        final_chunks = self.merge_and_deduplicate_chunks(initial_chunks, additional_chunks)
```

## ğŸš€ å·¥ç¨‹åŒ–äº®ç‚¹

### 1. GPUåŠ é€Ÿä¼˜åŒ–

#### BGE-ReRanker GPUéƒ¨ç½²
```python
# è‡ªåŠ¨GPUæ£€æµ‹å’Œå¼ºåˆ¶ç§»åŠ¨
if gpu_available:
    self.reranker.model = self.reranker.model.cuda()
    # å¯ç”¨FP16ç²¾åº¦æå‡æ€§èƒ½
    self.reranker.model = self.reranker.model.half()
```

#### è®¾å¤‡ä¿¡æ¯ç›‘æ§
```python
gpu_available = torch.cuda.is_available()
device_count = torch.cuda.device_count()
print(f"ğŸ” æ£€æµ‹åˆ° {device_count} ä¸ªGPUè®¾å¤‡: {torch.cuda.get_device_name(0)}")
```

### 2. ç½‘ç»œç¯å¢ƒé€‚é…

#### é­”æ­+HuggingFaceåŒæºç­–ç•¥
```python
# ä¼˜å…ˆä½¿ç”¨é­”æ­ï¼ˆå›½å†…ç½‘ç»œå‹å¥½ï¼‰
model_dir = snapshot_download(
    'BAAI/bge-reranker-large',
    cache_dir='./modelscope_cache'
)

# å¤±è´¥æ—¶è‡ªåŠ¨é™çº§åˆ°HuggingFace
except Exception:
    self.reranker = FlagReranker('BAAI/bge-reranker-large')
```

### 3. æ–­ç‚¹ç»­è·‘æœºåˆ¶

#### è¿›åº¦ç®¡ç†
```python
class CheckpointManager:
    def save_progress(self, completed_indices, results):
        # ä¿å­˜å¤„ç†è¿›åº¦å’Œç»“æœç¼“å­˜
        checkpoint_data = {
            'completed_indices': list(completed_indices),
            'timestamp': time.time()
        }
    
    def load_progress(self):
        # æ¢å¤ä¸­æ–­çš„ä»»åŠ¡
        return completed_indices, cached_results
```

#### ä¼˜é›…é€€å‡ºå¤„ç†
```python
def signal_handler(sig, frame):
    print("æ”¶åˆ°é€€å‡ºä¿¡å·ï¼Œæ­£åœ¨ä¿å­˜è¿›åº¦...")
    checkpoint_manager.save_progress(completed_indices, results)
    sys.exit(0)

signal.signal(signal.SIGINT, signal_handler)  # Ctrl+C
```

### 4. å¤šçº¿ç¨‹å¤„ç†ä¼˜åŒ–

```python
# GPUç¯å¢ƒä¸‹ä½¿ç”¨å¤šçº¿ç¨‹æå‡æ•ˆç‡
with concurrent.futures.ThreadPoolExecutor(max_workers=3) as executor:
    futures = {executor.submit(process_one_safe, idx): idx for idx in remaining_indices}
    
    for future in tqdm(concurrent.futures.as_completed(futures)):
        result = future.result()
        # å®šæœŸä¿å­˜æ–­ç‚¹
        if len(completed_indices) % 10 == 0:
            checkpoint_manager.save_progress(completed_indices, results)
```

## ğŸ“Š æ€§èƒ½åˆ†æ

### åˆ†å—ç­–ç•¥æ•ˆæœ
```
Chunkç±»å‹åˆ†å¸ƒ:
  page: 1205 ä¸ª          # é¡µé¢çº§chunks - ä¿è¯é¡µç åŒ¹é…
  paragraph: 3420 ä¸ª     # æ®µè½çº§chunks - æå‡å†…å®¹ç›¸ä¼¼åº¦
  table: 156 ä¸ª          # è¡¨æ ¼chunks - ç»“æ„åŒ–å†…å®¹
  cross_page: 892 ä¸ª     # è·¨é¡µchunks - è¾¹ç•Œä¿¡æ¯ä¿æŠ¤
```

### æ£€ç´¢æ€§èƒ½
```
æ£€ç´¢æµç¨‹ï¼šæ‰€æœ‰æ–‡æ¡£(~1000) â†’ ç²—å¬å›(25ä¸ª) â†’ ç²¾æ’åº(7ä¸ª) â†’ æœ€ç»ˆç»“æœ
å¤„ç†é€Ÿåº¦ï¼š~3ä¸ªé—®é¢˜/åˆ†é’Ÿï¼ˆGPUåŠ é€Ÿï¼‰
å‡†ç¡®ç‡æå‡ï¼šä»100åˆ† â†’ 105-110åˆ†ï¼ˆ+5-10åˆ†ï¼‰
```

### ç³»ç»Ÿèµ„æºä½¿ç”¨
- **GPUå†…å­˜**ï¼šBGE-ReRankerçº¦å ç”¨4-6GB
- **CPUå†…å­˜**ï¼šå‘é‡å­˜å‚¨çº¦å ç”¨8-12GB
- **ç£ç›˜ç©ºé—´**ï¼šæ¨¡å‹ç¼“å­˜çº¦å ç”¨2-3GB

## ğŸ”§ éƒ¨ç½²æŒ‡å—

### ç¯å¢ƒä¾èµ–
```bash
# æ ¸å¿ƒä¾èµ–
pip install torch transformers FlagEmbedding
pip install modelscope openai python-dotenv
pip install numpy tqdm concurrent-futures

# MinerUè§£æå¼•æ“
pip install magic-pdf[full]
```

### é…ç½®æ–‡ä»¶ï¼ˆ.envï¼‰
```bash
# æœ¬åœ°APIé…ç½®
LOCAL_API_KEY=your_api_key
LOCAL_BASE_URL=your_base_url
LOCAL_TEXT_MODEL=qwen-plus
LOCAL_EMBEDDING_MODEL=text-embedding-v1

# GPUä¼˜åŒ–
CUDA_VISIBLE_DEVICES=0
```

### è¿è¡Œæµç¨‹
```bash
# 1. PDFè§£æå’Œåˆ†å—
python mineru_pipeline_all.py

# 2. è¿è¡ŒRAGæ£€ç´¢
python rag_from_page_chunks.py

# 3. æŸ¥çœ‹ç»“æœ
cat enhanced_rag_pred.json
```

## ğŸ¯ ä¼˜åŒ–å»ºè®®

### çŸ­æœŸä¼˜åŒ–ï¼ˆå·²å®ç°ï¼‰
- âœ… åŒé˜¶æ®µæ£€ç´¢æ¶æ„
- âœ… å¢å¼ºåˆ†å—ç­–ç•¥
- âœ… åæ€é‡å†™æœºåˆ¶
- âœ… GPUåŠ é€Ÿéƒ¨ç½²

### ä¸­æœŸä¼˜åŒ–ï¼ˆè¿›è¡Œä¸­ï¼‰
- ğŸ”„ æ¨¡å‹å¾®è°ƒï¼šQwen2.5-7Bé’ˆå¯¹æ€§è®­ç»ƒ
- ğŸ”„ å‘é‡æ¨¡å‹ä¼˜åŒ–ï¼šæ›´é€‚åˆä¸­æ–‡çš„embeddingæ¨¡å‹
- ğŸ”„ å¤šæ¨¡æ€èåˆï¼šå›¾æ–‡ä¿¡æ¯çš„æ·±åº¦æ•´åˆ

### é•¿æœŸä¼˜åŒ–ï¼ˆè§„åˆ’ä¸­ï¼‰
- ğŸ“‹ çŸ¥è¯†å›¾è°±é›†æˆï¼šç»“æ„åŒ–çŸ¥è¯†å¢å¼º
- ğŸ“‹ å®æ—¶æ›´æ–°æœºåˆ¶ï¼šå¢é‡æ–‡æ¡£å¤„ç†
- ğŸ“‹ å¤šè½®å¯¹è¯æ”¯æŒï¼šä¸Šä¸‹æ–‡è®°å¿†èƒ½åŠ›

## ğŸ’¡ æŠ€æœ¯äº®ç‚¹æ€»ç»“

### åˆ›æ–°æ€§
1. **äº”ç»´åº¦åˆ†å—ç­–ç•¥**ï¼šé’ˆå¯¹è¯„åˆ†è§„åˆ™çš„ç²¾å‡†ä¼˜åŒ–
2. **åæ€é‡å†™æœºåˆ¶**ï¼šæ™ºèƒ½çš„ä¿¡æ¯å……è¶³æ€§åˆ¤æ–­
3. **å¤šæ¨¡æ€è§†è§‰å¢å¼º**ï¼šè‡ªåŠ¨å›¾ç‰‡ç†è§£èƒ½åŠ›

### å·¥ç¨‹æ€§
1. **æ–­ç‚¹ç»­è·‘**ï¼šå¤§è§„æ¨¡ä»»åŠ¡çš„å¯é æ€§ä¿éšœ
2. **ç½‘ç»œé€‚é…**ï¼šå›½å†…å¤–ç¯å¢ƒçš„æ™ºèƒ½åˆ‡æ¢
3. **GPUä¼˜åŒ–**ï¼šé«˜æ€§èƒ½è®¡ç®—èµ„æºçš„å……åˆ†åˆ©ç”¨

### å®ç”¨æ€§
1. **å³æ’å³ç”¨**ï¼šå®Œæ•´çš„ç«¯åˆ°ç«¯è§£å†³æ–¹æ¡ˆ
2. **ä¸­æ–‡ä¼˜åŒ–**ï¼šé’ˆå¯¹ä¸­æ–‡åœºæ™¯çš„æ·±åº¦é€‚é…
3. **æ•ˆæœéªŒè¯**ï¼šçœŸå®æ¯”èµ›åœºæ™¯çš„æ€§èƒ½è¯æ˜

## ğŸŒŸ å¼€æºä»·å€¼

### æŠ€æœ¯ä»·å€¼
- **å®Œæ•´çš„RAGæ¡†æ¶**ï¼šä»è§£æåˆ°æ£€ç´¢çš„å…¨é“¾è·¯æ–¹æ¡ˆ
- **ä¸­æ–‡å¤šæ¨¡æ€ä¼˜åŒ–**ï¼šå¡«è¡¥å¼€æºç¤¾åŒºçš„ç©ºç™½
- **å·¥ç¨‹åŒ–ç¨‹åº¦é«˜**ï¼šå¯ç›´æ¥ç”¨äºç”Ÿäº§ç¯å¢ƒ

### ç¤¾åŒºä»·å€¼
- **å®æˆ˜ç»éªŒåˆ†äº«**ï¼šçœŸå®é¡¹ç›®çš„æŠ€æœ¯æ²‰æ·€
- **æœ€ä½³å®è·µæ€»ç»“**ï¼šå·¥ç¨‹åŒ–éƒ¨ç½²çš„å®Œæ•´æŒ‡å—
- **æŒç»­ä¼˜åŒ–è¿­ä»£**ï¼šæ´»è·ƒçš„æŠ€æœ¯äº¤æµå’Œæ”¹è¿›

### å•†ä¸šä»·å€¼
- **ä¼ä¸šçº§åº”ç”¨**ï¼šé€‚ç”¨äºæ–‡æ¡£æ™ºèƒ½ã€çŸ¥è¯†ç®¡ç†ç­‰åœºæ™¯
- **å®šåˆ¶åŒ–æœåŠ¡**ï¼šå¯æ ¹æ®å…·ä½“éœ€æ±‚è¿›è¡Œé€‚é…
- **æŠ€æœ¯å’¨è¯¢**ï¼šæä¾›RAGç³»ç»Ÿå»ºè®¾çš„ä¸“ä¸šæŒ‡å¯¼

---

## ğŸ“ è”ç³»æ–¹å¼

å¦‚æœæ‚¨å¯¹è¿™å¥—å¤šæ¨¡æ€RAGç³»ç»Ÿæ„Ÿå…´è¶£ï¼Œæ¬¢è¿äº¤æµè®¨è®ºï¼š
- æŠ€æœ¯äº¤æµï¼šç³»ç»Ÿæ¶æ„ã€ä¼˜åŒ–ç­–ç•¥
- åˆä½œæœºä¼šï¼šå¼€æºè´¡çŒ®ã€å•†ä¸šåº”ç”¨
- é—®é¢˜åé¦ˆï¼šä½¿ç”¨ä¸­é‡åˆ°çš„æŠ€æœ¯é—®é¢˜

**è®©æˆ‘ä»¬ä¸€èµ·æ¨åŠ¨ä¸­æ–‡å¤šæ¨¡æ€RAGæŠ€æœ¯çš„å‘å±•ï¼** ğŸš€